<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚äº’å‹•æŠ•ç¥¨ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --primary: #4834d4;
            --accent: #eb4d4b;
            --text: #2f3542;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text);
            display: flex;
            justify-content: center;
        }

        .main-container {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            text-align: center;
        }

        /* --- ç®¡ç†è€…å„€è¡¨æ¿æ¨£å¼ --- */
        .admin-dashboard {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            background: #ffeaa7;
            padding: 5px 15px;
            border-radius: 50px;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 15px;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #d63031;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse-animation 1.5s infinite;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(214, 48, 49, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(214, 48, 49, 0);
            }
        }

        .qr-header {
            margin-bottom: 20px;
        }

        #qrcode {
            background: white;
            padding: 15px;
            display: inline-block;
            border: 3px solid var(--primary);
            border-radius: 15px;
        }

        .question-box {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 30px 0;
            color: var(--primary);
            border-bottom: 2px dashed #ddd;
            padding-bottom: 15px;
        }

        .chart-box {
            height: 400px;
            margin-top: 20px;
        }

        /* --- æŠ•ç¥¨è€…æ¨£å¼ (ç°¡ç´„) --- */
        .voter-card {
            background: white;
            padding: 40px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .voter-question {
            font-size: 1.8rem;
            margin-bottom: 30px;
        }

        .vote-btn {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 10px 0;
            font-size: 1.3rem;
            font-weight: bold;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .vote-btn:hover {
            background: #3c2bb3;
            transform: scale(1.02);
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div class="main-container">

        <div id="admin-view" class="admin-dashboard hidden">
            <div class="live-badge">
                <div class="pulse"></div> ğŸ“Š ç¾å ´å³æ™‚çµ±è¨ˆä¸­
            </div>

            <div class="qr-header">
                <div id="qrcode"></div>
                <p style="font-weight: bold; font-size: 1.2rem; margin-top: 10px;">
                    <i class="fa-solid fa-mobile-screen-button"></i> æ‰‹æ©Ÿæƒæ QR Code åƒèˆ‡æŠ•ç¥¨
                </p>
            </div>

            <div id="admin-question" class="question-box">è¼‰å…¥é¡Œç›®ä¸­...</div>

            <div class="chart-box">
                <canvas id="liveChart"></canvas>
            </div>
        </div>

        <div id="voter-view" class="voter-card hidden">
            <div id="voter-question" class="voter-question">è¼‰å…¥é¡Œç›®ä¸­...</div>
            <div id="option-list"></div>
            <p id="msg" style="margin-top: 20px; font-weight: bold;"></p>
        </div>

    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzCQPix_vOuIbrKRnqYXBe2qH5wvHGzmUYCHWl8xZx_1jSVsXPbknzJe5H9PbiycaU-DQ/exec";
        const isAdmin = new URLSearchParams(window.location.search).get('mode') === 'admin';
        let chartObj = null;

        async function init() {
            if (isAdmin) {
                document.getElementById('admin-view').classList.remove('hidden');
                // ç”¢ç”Ÿ QR Code
                const currentUrl = window.location.origin + window.location.pathname;
                new QRCode(document.getElementById("qrcode"), { text: currentUrl, width: 280, height: 280 });

                updateAdminData();
                setInterval(updateAdminData, 3000);
            } else {
                document.getElementById('voter-view').classList.remove('hidden');
                loadVoterData();
            }
        }

        // ç®¡ç†è€…è³‡æ–™æŠ“å–èˆ‡æ›´æ–°
        async function updateAdminData() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                document.getElementById('admin-question').innerText = `Q: ${data.question.title}`;

                const labels = Object.keys(data.stats);
                const values = Object.values(data.stats);

                if (!chartObj) {
                    const ctx = document.getElementById('liveChart').getContext('2d');
                    chartObj = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'å¾—ç¥¨æ•¸',
                                data: values,
                                backgroundColor: ['#4834d4', '#686de0', '#4ea1d3', '#22a6b3'],
                                borderRadius: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                        }
                    });
                } else {
                    chartObj.data.labels = labels;
                    chartObj.data.datasets[0].data = values;
                    chartObj.update();
                }
            } catch (e) { console.error(e); }
        }

        // æŠ•ç¥¨è€…è³‡æ–™æŠ“å–
        async function loadVoterData() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                document.getElementById('voter-question').innerText = data.question.title;
                const list = document.getElementById('option-list');
                data.question.options.forEach(opt => {
                    const b = document.createElement('button');
                    b.className = 'vote-btn';
                    b.innerText = opt;
                    b.onclick = () => sendVote(data.question.id, opt);
                    list.appendChild(b);
                });
            } catch (e) { }
        }

        async function sendVote(qid, opt) {
            document.getElementById('msg').innerText = "å‚³é€ä¸­...";
            document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true);
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ questionId: qid, option: opt }) });
                document.getElementById('msg').innerHTML = "<i class='fa-solid fa-circle-check'></i> æŠ•ç¥¨æˆåŠŸï¼è«‹æŠ¬é ­çœ‹çµæœ";
                document.getElementById('msg').style.color = "#2ecc71";
            } catch (e) {
                document.getElementById('msg').innerText = "ç™¼ç”ŸéŒ¯èª¤";
            }
        }

        init();
    </script>
</body>

</html>